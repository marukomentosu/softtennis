<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Soft Tennis Wide</title>
    <style>
        /* „Éô„Éº„Çπ„É¨„Ç§„Ç¢„Ç¶„Éà */
        body {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            margin: 0; padding: 0;
            background-color: #f0f0f0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* ÂÖ®‰Ωì„ÅÆ„Çπ„ÇØ„É≠„Éº„É´Á¶ÅÊ≠¢ */
            user-select: none; /* ÊñáÂ≠óÈÅ∏ÊäûÁ¶ÅÊ≠¢ */
            -webkit-user-select: none;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        #header-bar {
            background-color: white;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            z-index: 200;
            flex-shrink: 0;
            height: 44px; /* È´ò„ÅïÂõ∫ÂÆö */
        }

        #status-label { font-weight: bold; font-size: 14px; color: #333; }
        #btn-settings {
            background-color: #f5f5f5; border: 1px solid #ccc; border-radius: 4px;
            padding: 6px 12px; font-size: 12px; font-weight: bold; cursor: pointer;
        }

        /* Ë®≠ÂÆö„Ç™„Éº„Éê„Éº„É¨„Ç§ */
        #settings-overlay {
            display: none; position: absolute;
            top: 50px; left: 0; right: 0;
            background-color: rgba(255, 255, 255, 0.98);
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 300;
            flex-direction: column; gap: 10px;
        }
        #settings-overlay.show { display: flex; }
        .settings-title { font-weight: bold; color: #2E7D32; border-bottom: 2px solid #2E7D32; margin-bottom: 5px; }

        /* „Ç≠„É£„É≥„Éê„Çπ„Ç®„É™„Ç¢ */
        #canvas-container {
            flex: 1;
            background-color: #1b5e20;
            position: relative;
            cursor: crosshair;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
            z-index: 1;
            padding: 10px; /* ÂÆâÂÖ®„Éû„Éº„Ç∏„É≥ */
        }
        canvas {
            display: block;
            touch-action: none; 
        }

        /* ‰∏ãÈÉ®„Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´ */
        #controls {
            background-color: white;
            padding: 8px;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 6px;
            z-index: 100; flex-shrink: 0;
        }

        button {
            border: none; border-radius: 4px; font-weight: bold; cursor: pointer;
            touch-action: manipulation; transition: transform 0.1s;
        }
        button:active { transform: scale(0.96); opacity: 0.9; }

        .hitter-row { display: flex; gap: 6px; }
        .hitter-btn {
            flex: 1; padding: 10px 2px;
            background-color: #eee; font-size: 12px; color: #444;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .action-row { display: flex; gap: 6px; }
        .shot-btn {
            flex: 2; padding: 12px 0; font-size: 13px;
            background-color: #eee; color: #555; border: 1px solid #ddd;
        }
        .util-btn { flex: 1; font-size: 12px; background-color: #fff; border: 1px solid #ccc; color: #333; }

        .sub-row { display: flex; justify-content: space-between; align-items: center; margin-top: 2px; }
        .save-btn { background-color: #2196F3; color: white; padding: 6px 15px; font-size: 12px; }
        .clear-btn { background-color: #ffebee; color: #d32f2f; padding: 6px 10px; font-size: 11px; }

        .switch-group { display: flex; align-items: center; gap: 5px; font-size: 11px; font-weight: bold; color: #555; }
        input[type="checkbox"] { transform: scale(1.1); accent-color: #2E7D32; }

        /* „Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã */
        #btn-p1.active { background-color: #FFC107; color: black; box-shadow: 0 2px 0 #FFA000; }
        #btn-p2.active { background-color: #E91E63; color: white; box-shadow: 0 2px 0 #C2185B; }
        #btn-o1.active { background-color: #00BCD4; color: black; box-shadow: 0 2px 0 #0097A7; }
        #btn-o2.active { background-color: #CE93D8; color: black; box-shadow: 0 2px 0 #AB47BC; }
        .shot-btn.active { background-color: #2E7D32; color: white; border-color: #1B5E20; }
        #btn-lob { border-style: dashed; }
        #btn-lob.active { border-style: solid; }

        .input-group { display: flex; gap: 5px; }
        input[type="text"], input[type="datetime-local"] {
            flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;
        }
        .close-settings-btn {
            background-color: #2E7D32; color: white; padding: 10px; text-align: center;
            border-radius: 4px; margin-top: 10px;
        }
    </style>
</head>
<body>

    <div id="header-bar">
        <div id="status-label">‚ë†ÊâìÁÇπ„Çí„Çø„ÉÉ„Éó</div>
        <button id="btn-settings">‚öôÔ∏è Ë®≠ÂÆö</button>
    </div>

    <div id="settings-overlay">
        <div class="settings-title">Ë©¶ÂêàË®≠ÂÆö</div>
        <div class="input-group">
            <input type="text" id="input-tournament" placeholder="Â§ß‰ºöÂêç">
            <input type="datetime-local" id="input-date">
        </div>
        <div class="settings-title" style="margin-top:10px;">Âë≥Êñπ„ÉÅ„Éº„É†</div>
        <div class="input-group">
            <input type="text" id="input-p1" placeholder="ÈÅ∏Êâã1 (ÈªÑ)" value="Âë≥Êñπ1">
            <input type="text" id="input-p2" placeholder="ÈÅ∏Êâã2 (Ê°É)" value="Âë≥Êñπ2">
        </div>
        <div class="settings-title" style="margin-top:10px;">Áõ∏Êâã„ÉÅ„Éº„É†</div>
        <div class="input-group">
            <input type="text" id="input-o1" placeholder="ÈÅ∏Êâã1 (Ê∞¥)" value="Áõ∏Êâã1">
            <input type="text" id="input-o2" placeholder="ÈÅ∏Êâã2 (Á¥´)" value="Áõ∏Êâã2">
        </div>
        <button class="close-settings-btn" onclick="toggleSettings()">Èñâ„Åò„Çã</button>
    </div>

    <div id="canvas-container">
        <canvas id="courtCanvas"></canvas>
    </div>

    <div id="controls">
        <div class="hitter-row">
            <button id="btn-p1" class="hitter-btn active" onclick="selectHitter(0)">Âë≥Êñπ1</button>
            <button id="btn-p2" class="hitter-btn" onclick="selectHitter(1)">Âë≥Êñπ2</button>
        </div>
        <div class="hitter-row">
            <button id="btn-o1" class="hitter-btn" onclick="selectHitter(2)">Áõ∏Êâã1</button>
            <button id="btn-o2" class="hitter-btn" onclick="selectHitter(3)">Áõ∏Êâã2</button>
        </div>

        <div class="action-row">
            <button id="btn-shoot" class="shot-btn active" onclick="selectShotType('shoot')">„Ç∑„É•„Éº„Éà</button>
            <button id="btn-lob" class="shot-btn" onclick="selectShotType('lob')">„É≠„Éñ</button>
            <button id="btn-undo" class="util-btn">Êàª„Åô</button>
        </div>

        <div class="sub-row">
            <div style="display:flex; gap:10px;">
                <div class="switch-group">
                    <input type="checkbox" id="sw-lines" checked> Á∑ö
                </div>
                <div class="switch-group">
                    <input type="checkbox" id="sw-marks" checked> ÁÇπ
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button id="btn-clear" class="clear-btn">Ê∂àÂéª</button>
                <button id="btn-save" class="save-btn">üì∑ ‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <script>
        window.onload = function() {
            const canvas = document.getElementById('courtCanvas');
            const ctx = canvas.getContext('2d');
            const statusLabel = document.getElementById('status-label');
            const settingsOverlay = document.getElementById('settings-overlay');
            const btnSettings = document.getElementById('btn-settings');

            window.toggleSettings = function() {
                settingsOverlay.classList.toggle('show');
                btnSettings.textContent = settingsOverlay.classList.contains('show') ? "‚úñ Èñâ„Åò„Çã" : "‚öôÔ∏è Ë®≠ÂÆö";
            };
            btnSettings.addEventListener('click', window.toggleSettings);

            const inputT = document.getElementById('input-tournament');
            const inputD = document.getElementById('input-date');
            const inP1 = document.getElementById('input-p1'), inP2 = document.getElementById('input-p2');
            const inO1 = document.getElementById('input-o1'), inO2 = document.getElementById('input-o2');
            const btnP1 = document.getElementById('btn-p1'), btnP2 = document.getElementById('btn-p2');
            const btnO1 = document.getElementById('btn-o1'), btnO2 = document.getElementById('btn-o2');
            const btnShoot = document.getElementById('btn-shoot'), btnLob = document.getElementById('btn-lob');
            
            const PLAYER_COLORS = [
                { bg: '#FFC107', text: '#000000' }, { bg: '#E91E63', text: '#FFFFFF' },
                { bg: '#00BCD4', text: '#000000' }, { bg: '#CE93D8', text: '#000000' }
            ];

            let shots = [], tempStartPoint = null, dpr = 1, activeHitterIndex = 0, currentShotType = 'shoot';
            let courtGeometry = {};
            const config = { showLines: true, showMarks: true };
            const COURT_ASPECT = 10.97 / 23.77;

            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            inputD.value = now.toISOString().slice(0, 16);
            
            function updateLabels() {
                btnP1.textContent = inP1.value || "Âë≥Êñπ1"; btnP2.textContent = inP2.value || "Âë≥Êñπ2";
                btnO1.textContent = inO1.value || "Áõ∏Êâã1"; btnO2.textContent = inO2.value || "Áõ∏Êâã2";
            }
            [inP1,inP2,inO1,inO2].forEach(el => el.addEventListener('input', updateLabels));
            updateLabels();

            window.selectHitter = function(idx) {
                activeHitterIndex = idx;
                [btnP1,btnP2,btnO1,btnO2].forEach((b,i) => b.classList.toggle('active', i===idx));
                draw();
            };

            window.selectShotType = function(type) {
                currentShotType = type;
                btnShoot.classList.toggle('active', type==='shoot');
                btnLob.classList.toggle('active', type==='lob');
            };

            function getInitChar() {
                let v = "";
                if(activeHitterIndex===0) v = inP1.value;
                else if(activeHitterIndex===1) v = inP2.value;
                else if(activeHitterIndex===2) v = inO1.value;
                else if(activeHitterIndex===3) v = inO2.value;
                return v ? v.charAt(0) : String(activeHitterIndex+1);
            }

            function resizeCanvas() {
                const con = document.getElementById('canvas-container');
                dpr = window.devicePixelRatio || 1;
                canvas.width = con.clientWidth * dpr;
                canvas.height = con.clientHeight * dpr;
                canvas.style.width = con.clientWidth + 'px';
                canvas.style.height = con.clientHeight + 'px';
                ctx.scale(dpr, dpr);
                draw();
            }
            window.addEventListener('resize', resizeCanvas);

            function draw() {
                const w = canvas.width / dpr, h = canvas.height / dpr;
                ctx.fillStyle = '#1b5e20'; ctx.fillRect(0,0,w,h);
                ctx.setLineDash([]);

                // ‚òÖ‰øÆÊ≠£ÁÆáÊâÄ: „Ç≥„Éº„Éà„Çµ„Ç§„Ç∫„ÇíÊéß„Åà„ÇÅ„Å´Ôºà0.9 ‚Üí 0.75Ôºâ
                // „Åì„Çå„ÅßÁ¢∫ÂÆü„Å´Ë¶ãÂàá„Çå„ÇíÈò≤„Åé„Åæ„Åô
                const maxW = w * 0.75; 
                const maxH = h * 0.75;
                
                let cW, cH;
                if(maxH * COURT_ASPECT <= maxW) { cH = maxH; cW = cH * COURT_ASPECT; }
                else { cW = maxW; cH = cW / COURT_ASPECT; }
                
                const ox = (w-cW)/2, oy = (h-cH)/2, netY = oy+(cH/2);
                courtGeometry = { ox, oy, w:cW, h:cH, netY };

                // „Ç≥„Éº„Éà
                ctx.fillStyle = '#2E7D32'; ctx.fillRect(ox,oy,cW,cH);
                ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.strokeRect(ox,oy,cW,cH);
                const aw = cW*0.15;
                ctx.beginPath(); ctx.moveTo(ox+aw,oy); ctx.lineTo(ox+aw,oy+cH);
                ctx.moveTo(ox+cW-aw,oy); ctx.lineTo(ox+cW-aw,oy+cH); ctx.stroke();
                const sh = (cH/2)*0.55;
                ctx.beginPath(); ctx.moveTo(ox+aw,netY-sh); ctx.lineTo(ox+cW-aw,netY-sh);
                ctx.moveTo(ox+aw,netY+sh); ctx.lineTo(ox+cW-aw,netY+sh); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(ox+cW/2,netY-sh); ctx.lineTo(ox+cW/2,netY+sh); ctx.stroke();
                ctx.strokeStyle = '#ddd'; ctx.lineWidth = 4;
                ctx.beginPath(); ctx.moveTo(ox-10,netY); ctx.lineTo(ox+cW+10,netY); ctx.stroke();

                // ËªåË∑°
                if(config.showLines) {
                    shots.forEach(s => {
                        const c = (s.color==='#2196F3') ? {r:33,g:150,b:243} : (s.color==='#F44336'?{r:244,g:67,b:54}:{r:255,g:255,b:255});
                        ctx.strokeStyle = `rgba(${c.r},${c.g},${c.b},0.6)`;
                        ctx.lineWidth = 2;
                        if(s.type==='lob') ctx.setLineDash([5,5]); else ctx.setLineDash([]);
                        ctx.beginPath(); ctx.moveTo(s.start.x,s.start.y); ctx.lineTo(s.end.x,s.end.y); ctx.stroke();
                    });
                    ctx.setLineDash([]);
                }
                // „Éû„Éº„ÇØ
                if(config.showMarks) {
                    ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font='bold 12px sans-serif';
                    shots.forEach(s => {
                        const pc = PLAYER_COLORS[s.hitterIndex];
                        ctx.fillStyle = pc.bg; ctx.beginPath(); ctx.arc(s.start.x,s.start.y,12,0,Math.PI*2); ctx.fill();
                        ctx.fillStyle = pc.text; ctx.fillText(s.initial,s.start.x,s.start.y+1);
                        ctx.fillStyle = s.color; ctx.strokeStyle='white'; ctx.lineWidth=1.5;
                        ctx.beginPath(); ctx.arc(s.end.x,s.end.y,6,0,Math.PI*2); ctx.fill(); ctx.stroke();
                    });
                }
                // „Ç¨„Ç§„Éâ
                if(tempStartPoint) {
                    const pc = PLAYER_COLORS[activeHitterIndex];
                    ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.beginPath(); ctx.arc(tempStartPoint.x,tempStartPoint.y,16,0,Math.PI*2); ctx.fill();
                    ctx.fillStyle = pc.bg; ctx.beginPath(); ctx.arc(tempStartPoint.x,tempStartPoint.y,12,0,Math.PI*2); ctx.fill();
                    ctx.fillStyle = pc.text; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font='bold 12px sans-serif';
                    ctx.fillText(getInitChar(), tempStartPoint.x, tempStartPoint.y+1);
                }
            }

            function handlePointerDown(e) {
                if(e.target === canvas) {
                    e.preventDefault();
                    canvas.setPointerCapture(e.pointerId);
                    
                    const rect = canvas.getBoundingClientRect();
                    const pt = { x: e.clientX - rect.left, y: e.clientY - rect.top };
                    
                    if(!tempStartPoint) {
                        tempStartPoint = pt;
                        statusLabel.textContent = "ÁùÄÂºæÁÇπ„Çí„Çø„ÉÉ„Éó";
                    } else {
                        const start = tempStartPoint;
                        const end = pt;
                        const { ox, oy, w, h, netY } = courtGeometry;
                        let c = 'white', m = "IN";
                        
                        if (Math.abs(end.y - netY) < (h * 0.05)) { c = '#2196F3'; m = "NET"; }
                        else if ((ox <= end.x && end.x <= ox + w) && (oy <= end.y && end.y <= oy + h)) { c = 'white'; m = "IN"; }
                        else { c = '#F44336'; m = "OUT"; }

                        shots.push({
                            start, end, color: c,
                            initial: getInitChar(),
                            hitterIndex: activeHitterIndex,
                            type: currentShotType
                        });
                        tempStartPoint = null;
                        statusLabel.textContent = `${m} (${getInitChar()}) ÂÆå‰∫Ü`;
                    }
                    draw();
                }
            }
            canvas.addEventListener('pointerdown', handlePointerDown);

            document.getElementById('sw-lines').addEventListener('change', e=>{ config.showLines=e.target.checked; draw(); });
            document.getElementById('sw-marks').addEventListener('change', e=>{ config.showMarks=e.target.checked; draw(); });
            
            document.getElementById('btn-undo').addEventListener('click', ()=>{
                if(tempStartPoint) { tempStartPoint=null; statusLabel.textContent="„Ç≠„É£„É≥„Çª„É´"; }
                else if(shots.length>0) { shots.pop(); statusLabel.textContent="Êàª„Åó„Åæ„Åó„Åü"; }
                draw();
            });
            
            document.getElementById('btn-clear').addEventListener('click', ()=>{
                if(confirm('ÂÖ®Ê∂àÂéª„Åó„Åæ„Åô„ÅãÔºü')) { shots=[]; tempStartPoint=null; statusLabel.textContent="‚ë†ÊâìÁÇπ„Çí„Çø„ÉÉ„Éó"; draw(); }
            });

            document.getElementById('btn-save').addEventListener('click', ()=>{
                try {
                    const link = document.createElement('a');
                    let fn = "";
                    const t=inputT.value.trim(); if(t) fn+=t+"_";
                    
                    const m1=inP1.value.trim(), m2=inP2.value.trim();
                    let mt = (m1&&m2) ? m1+"„Éª"+m2 : (m1||m2);
                    if(mt) fn+=mt;
                    
                    const o1=inO1.value.trim(), o2=inO2.value.trim();
                    let ot = (o1&&o2) ? o1+"„Éª"+o2 : (o1||o2);
                    if(mt&&ot) fn+="_vs_";
                    if(ot) fn+=ot;
                    
                    if(fn) fn+="_";
                    fn += inputD.value.replace(/[-:]/g,'').replace('T','_') || "tennis";
                    link.download = fn+".png";

                    const m=30;
                    const cx=(courtGeometry.ox-m)*dpr, cy=(courtGeometry.oy-m)*dpr;
                    const cw=(courtGeometry.w+m*2)*dpr, ch=(courtGeometry.h+m*2)*dpr;
                    const fx=Math.max(0,cx), fy=Math.max(0,cy);
                    const fw=Math.min(canvas.width-fx,cw), fh=Math.min(canvas.height-fy,ch);
                    
                    const oc = document.createElement('canvas');
                    oc.width=fw; oc.height=fh;
                    const octx = oc.getContext('2d');
                    octx.drawImage(canvas,fx,fy,fw,fh,0,0,fw,fh);
                    
                    link.href = oc.toDataURL('image/png');
                    link.click();
                    statusLabel.textContent = "‰øùÂ≠òÂÆå‰∫Ü";
                } catch(e) { alert("‰øùÂ≠ò„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü"); }
            });

            resizeCanvas();
        };
    </script>
</body>
</html>
