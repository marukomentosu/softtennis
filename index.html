<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Soft Tennis Wide</title>
    <style>
        /* „Éô„Éº„Çπ„É¨„Ç§„Ç¢„Ç¶„Éà */
        body {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            margin: 0; padding: 0;
            background-color: #f0f0f0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* „Éò„ÉÉ„ÉÄ„ÉºÔºà„Çπ„ÉÜ„Éº„Çø„Çπ„Å®Ë®≠ÂÆö„Éú„Çø„É≥Ôºâ */
        #header-bar {
            background-color: white;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            z-index: 200;
        }

        #status-label {
            font-weight: bold; font-size: 14px; color: #333;
        }

        #btn-settings {
            background-color: #f5f5f5;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Ë®≠ÂÆö„Ç™„Éº„Éê„Éº„É¨„Ç§ÔºàÂÖ•ÂäõÊ¨ÑÔºâ */
        #settings-overlay {
            display: none; /* „Éá„Éï„Ç©„É´„ÉàÈùûË°®Á§∫ */
            position: absolute;
            top: 45px; /* „Éò„ÉÉ„ÉÄ„Éº„ÅÆ‰∏ã */
            left: 0; right: 0;
            background-color: rgba(255, 255, 255, 0.98);
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 300;
            flex-direction: column;
            gap: 10px;
        }
        #settings-overlay.show { display: flex; }

        .settings-title { font-weight: bold; color: #2E7D32; border-bottom: 2px solid #2E7D32; margin-bottom: 5px; }

        /* „Ç≠„É£„É≥„Éê„Çπ„Ç®„É™„Ç¢ */
        #canvas-container {
            flex: 1;
            background-color: #1b5e20;
            position: relative;
            cursor: crosshair;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
            z-index: 1;
        }
        canvas { display: block; touch-action: none; }

        /* ‰∏ãÈÉ®„Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´ÔºàÊìç‰Ωú„Éú„Çø„É≥Ôºâ */
        #controls {
            background-color: white;
            padding: 8px;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 6px;
            z-index: 100;
        }

        /* „Éú„Çø„É≥ÂÖ±ÈÄö„Çπ„Çø„Ç§„É´ */
        button {
            border: none; border-radius: 4px; font-weight: bold; cursor: pointer;
            touch-action: manipulation; transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); opacity: 0.8; }

        /* ÈÅ∏Êâã„Éú„Çø„É≥Ë°å */
        .hitter-row { display: flex; gap: 6px; }
        .hitter-btn {
            flex: 1; padding: 10px 2px;
            background-color: #eee; font-size: 12px; color: #444;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* „Ç¢„ÇØ„Ç∑„Éß„É≥Ë°åÔºà„Ç∑„É•„Éº„Éà/„É≠„Éñ/Êàª„ÇãÔºâ */
        .action-row { display: flex; gap: 6px; }
        
        .shot-btn {
            flex: 2; padding: 12px 0; font-size: 13px;
            background-color: #eee; color: #555;
            border: 1px solid #ddd;
        }
        
        .util-btn {
            flex: 1; font-size: 12px; background-color: #fff; border: 1px solid #ccc; color: #333;
        }

        /* „Çµ„Éñ„É°„Éã„É•„ÉºË°åÔºà‰øùÂ≠ò/„ÇØ„É™„Ç¢/Ë°®Á§∫ÂàáÊõøÔºâ */
        .sub-row { display: flex; justify-content: space-between; align-items: center; margin-top: 2px; }
        .save-btn { background-color: #2196F3; color: white; padding: 6px 15px; font-size: 12px; }
        .clear-btn { background-color: #ffebee; color: #d32f2f; padding: 6px 10px; font-size: 11px; }

        /* „Çπ„Ç§„ÉÉ„ÉÅÈ°û */
        .switch-group { display: flex; align-items: center; gap: 5px; font-size: 11px; font-weight: bold; color: #555; }
        input[type="checkbox"] { transform: scale(1.1); accent-color: #2E7D32; }

        /* „Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÅÆËâ≤ */
        /* Âë≥Êñπ */
        #btn-p1.active { background-color: #FFC107; color: black; box-shadow: 0 2px 0 #FFA000; }
        #btn-p2.active { background-color: #E91E63; color: white; box-shadow: 0 2px 0 #C2185B; }
        /* Áõ∏Êâã */
        #btn-o1.active { background-color: #00BCD4; color: black; box-shadow: 0 2px 0 #0097A7; }
        #btn-o2.active { background-color: #CE93D8; color: black; box-shadow: 0 2px 0 #AB47BC; }

        /* ÁêÉÁ®Æ */
        .shot-btn.active { background-color: #2E7D32; color: white; border-color: #1B5E20; }
        #btn-lob { border-style: dashed; }
        #btn-lob.active { border-style: solid; }

        /* ÂÖ•ÂäõÊ¨Ñ„Çπ„Çø„Ç§„É´ */
        .input-group { display: flex; gap: 5px; }
        input[type="text"], input[type="datetime-local"] {
            flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;
        }
        
        .close-settings-btn {
            background-color: #2E7D32; color: white; padding: 10px; text-align: center;
            border-radius: 4px; margin-top: 10px;
        }
    </style>
</head>
<body>

    <div id="header-bar">
        <div id="status-label">‚ë†ÊâìÁÇπ„Çí„Çø„ÉÉ„Éó</div>
        <button id="btn-settings">‚öôÔ∏è Ë®≠ÂÆö (ÂêçÂâç„ÉªÊó•ÊôÇ)</button>
    </div>

    <div id="settings-overlay">
        <div class="settings-title">Ë©¶ÂêàË®≠ÂÆö</div>
        
        <div class="input-group">
            <input type="text" id="input-tournament" placeholder="Â§ß‰ºöÂêç">
            <input type="datetime-local" id="input-date">
        </div>

        <div class="settings-title" style="margin-top:10px;">Âë≥Êñπ„ÉÅ„Éº„É†</div>
        <div class="input-group">
            <input type="text" id="input-p1" placeholder="ÈÅ∏Êâã1 (ÈªÑ)" value="Âë≥Êñπ1">
            <input type="text" id="input-p2" placeholder="ÈÅ∏Êâã2 (Ê°É)" value="Âë≥Êñπ2">
        </div>

        <div class="settings-title" style="margin-top:10px;">Áõ∏Êâã„ÉÅ„Éº„É†</div>
        <div class="input-group">
            <input type="text" id="input-o1" placeholder="ÈÅ∏Êâã1 (Ê∞¥)" value="Áõ∏Êâã1">
            <input type="text" id="input-o2" placeholder="ÈÅ∏Êâã2 (Á¥´)" value="Áõ∏Êâã2">
        </div>

        <button class="close-settings-btn" onclick="toggleSettings()">Èñâ„Åò„Çã</button>
    </div>

    <div id="canvas-container">
        <canvas id="courtCanvas"></canvas>
    </div>

    <div id="controls">
        <div class="hitter-row">
            <button id="btn-p1" class="hitter-btn active" onclick="selectHitter(0)">Âë≥Êñπ1</button>
            <button id="btn-p2" class="hitter-btn" onclick="selectHitter(1)">Âë≥Êñπ2</button>
        </div>
        <div class="hitter-row">
            <button id="btn-o1" class="hitter-btn" onclick="selectHitter(2)">Áõ∏Êâã1</button>
            <button id="btn-o2" class="hitter-btn" onclick="selectHitter(3)">Áõ∏Êâã2</button>
        </div>

        <div class="action-row">
            <button id="btn-shoot" class="shot-btn active" onclick="selectShotType('shoot')">„Ç∑„É•„Éº„Éà(ÂÆüÁ∑ö)</button>
            <button id="btn-lob" class="shot-btn" onclick="selectShotType('lob')">„É≠„Éñ(ÁÇπÁ∑ö)</button>
            <button id="btn-undo" class="util-btn">1„Å§Êàª„Åô</button>
        </div>

        <div class="sub-row">
            <div style="display:flex; gap:10px;">
                <div class="switch-group">
                    <input type="checkbox" id="sw-lines" checked> Á∑ö
                </div>
                <div class="switch-group">
                    <input type="checkbox" id="sw-marks" checked> ÁÇπ
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button id="btn-clear" class="clear-btn">ÂÖ®Ê∂àÂéª</button>
                <button id="btn-save" class="save-btn">üì∑ ÁîªÂÉè‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('courtCanvas');
        const ctx = canvas.getContext('2d');
        const statusLabel = document.getElementById('status-label');
        
        // Ë®≠ÂÆö„Éë„Éç„É´„ÅÆÈñãÈñâ
        const settingsOverlay = document.getElementById('settings-overlay');
        const btnSettings = document.getElementById('btn-settings');
        
        window.toggleSettings = function() {
            settingsOverlay.classList.toggle('show');
            if(settingsOverlay.classList.contains('show')) {
                btnSettings.textContent = "‚úñ Èñâ„Åò„Çã";
                btnSettings.style.backgroundColor = "#ddd";
            } else {
                btnSettings.textContent = "‚öôÔ∏è Ë®≠ÂÆö (ÂêçÂâç„ÉªÊó•ÊôÇ)";
                btnSettings.style.backgroundColor = "#f5f5f5";
            }
        };
        btnSettings.addEventListener('click', window.toggleSettings);

        // ÂÖ•ÂäõÊ¨Ñ
        const inputTournament = document.getElementById('input-tournament');
        const inputDate = document.getElementById('input-date');
        const inputP1 = document.getElementById('input-p1');
        const inputP2 = document.getElementById('input-p2');
        const inputO1 = document.getElementById('input-o1');
        const inputO2 = document.getElementById('input-o2');

        // „Éú„Çø„É≥
        const btnP1 = document.getElementById('btn-p1');
        const btnP2 = document.getElementById('btn-p2');
        const btnO1 = document.getElementById('btn-o1');
        const btnO2 = document.getElementById('btn-o2');
        const btnShoot = document.getElementById('btn-shoot');
        const btnLob = document.getElementById('btn-lob');

        const PLAYER_COLORS = [
            { bg: '#FFC107', text: '#000000' },
            { bg: '#E91E63', text: '#FFFFFF' },
            { bg: '#00BCD4', text: '#000000' },
            { bg: '#CE93D8', text: '#000000' }
        ];

        let shots = [];
        let tempStartPoint = null;
        let dpr = 1;
        let activeHitterIndex = 0;
        let currentShotType = 'shoot';
        let courtGeometry = { ox: 0, oy: 0, w: 0, h: 0, netY: 0 };
        const config = { showLines: true, showMarks: true };
        const COURT_ASPECT_RATIO = 10.97 / 23.77;

        // ÂàùÊúüÂåñ
        function init() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            inputDate.value = now.toISOString().slice(0, 16);
            updateButtonLabels();
            resizeCanvas();
        }

        function updateButtonLabels() {
            btnP1.textContent = (inputP1.value.trim() || "Âë≥Êñπ1");
            btnP2.textContent = (inputP2.value.trim() || "Âë≥Êñπ2");
            btnO1.textContent = (inputO1.value.trim() || "Áõ∏Êâã1");
            btnO2.textContent = (inputO2.value.trim() || "Áõ∏Êâã2");
        }
        [inputP1, inputP2, inputO1, inputO2].forEach(el => el.addEventListener('input', updateButtonLabels));

        // ÈÅ∏ÊâãÈÅ∏Êäû
        window.selectHitter = function(index) {
            activeHitterIndex = index;
            [btnP1, btnP2, btnO1, btnO2].forEach((btn, i) => {
                if(i === index) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            draw();
        };

        // ÁêÉÁ®ÆÈÅ∏Êäû
        window.selectShotType = function(type) {
            currentShotType = type;
            if(type === 'shoot') {
                btnShoot.classList.add('active');
                btnLob.classList.remove('active');
            } else {
                btnShoot.classList.remove('active');
                btnLob.classList.add('active');
            }
        };

        function getInitial(name) {
            if (!name) return "";
            return name.charAt(0);
        }

        function getCurrentInitial() {
            let name = "";
            if (activeHitterIndex === 0) name = inputP1.value;
            else if (activeHitterIndex === 1) name = inputP2.value;
            else if (activeHitterIndex === 2) name = inputO1.value;
            else if (activeHitterIndex === 3) name = inputO2.value;

            if (!name) return String(activeHitterIndex + 1);
            return getInitial(name);
        }

        function resizeCanvas() {
            const container = document.getElementById('canvas-container');
            dpr = window.devicePixelRatio || 1;
            canvas.width = container.clientWidth * dpr;
            canvas.height = container.clientHeight * dpr;
            canvas.style.width = container.clientWidth + 'px';
            canvas.style.height = container.clientHeight + 'px';
            ctx.scale(dpr, dpr);
            draw();
        }
        window.addEventListener('resize', resizeCanvas);
        
        function draw() {
            const w = canvas.width / dpr;
            const h = canvas.height / dpr;

            ctx.fillStyle = '#1b5e20';
            ctx.fillRect(0, 0, w, h);
            ctx.setLineDash([]);

            // „Ç≥„Éº„ÉàË®àÁÆó
            const maxW = w * 0.90;
            const maxH = h * 0.90;
            let courtW, courtH;
            if (maxH * COURT_ASPECT_RATIO <= maxW) {
                courtH = maxH; courtW = courtH * COURT_ASPECT_RATIO;
            } else {
                courtW = maxW; courtH = courtW / COURT_ASPECT_RATIO;
            }

            const ox = (w - courtW) / 2;
            const oy = (h - courtH) / 2;
            const netY = oy + (courtH / 2);
            courtGeometry = { ox, oy, w: courtW, h: courtH, netY };

            // „Ç≥„Éº„ÉàÊèèÁîª
            ctx.fillStyle = '#2E7D32';
            ctx.fillRect(ox, oy, courtW, courtH);
            ctx.strokeStyle = 'white'; ctx.lineWidth = 2;
            ctx.strokeRect(ox, oy, courtW, courtH);

            const alleyW = courtW * 0.15;
            ctx.beginPath();
            ctx.moveTo(ox + alleyW, oy); ctx.lineTo(ox + alleyW, oy + courtH);
            ctx.moveTo(ox + courtW - alleyW, oy); ctx.lineTo(ox + courtW - alleyW, oy + courtH);
            ctx.stroke();

            const serviceH = (courtH / 2) * 0.55;
            ctx.beginPath();
            ctx.moveTo(ox + alleyW, netY - serviceH); ctx.lineTo(ox + courtW - alleyW, netY - serviceH);
            ctx.moveTo(ox + alleyW, netY + serviceH); ctx.lineTo(ox + courtW - alleyW, netY + serviceH);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(ox + courtW / 2, netY - serviceH); ctx.lineTo(ox + courtW / 2, netY + serviceH);
            ctx.stroke();

            ctx.strokeStyle = '#dddddd'; ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(ox - (courtW * 0.05), netY); ctx.lineTo(ox + courtW + (courtW * 0.05), netY);
            ctx.stroke();

            // „Ç∑„Éß„ÉÉ„Éà
            if (config.showLines) {
                shots.forEach(shot => {
                    const c = parseColor(shot.color);
                    ctx.strokeStyle = `rgba(${c.r}, ${c.g}, ${c.b}, 0.6)`;
                    ctx.lineWidth = 2;
                    if (shot.type === 'lob') ctx.setLineDash([5, 5]);
                    else ctx.setLineDash([]);
                    ctx.beginPath();
                    ctx.moveTo(shot.start.x, shot.start.y);
                    ctx.lineTo(shot.end.x, shot.end.y);
                    ctx.stroke();
                });
                ctx.setLineDash([]);
            }

            if (config.showMarks) {
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.font = 'bold 12px sans-serif';
                shots.forEach(shot => {
                    const pColor = PLAYER_COLORS[shot.hitterIndex] || PLAYER_COLORS[0];
                    ctx.fillStyle = pColor.bg; 
                    ctx.beginPath(); ctx.arc(shot.start.x, shot.start.y, 12, 0, Math.PI * 2); ctx.fill();
                    ctx.fillStyle = pColor.text; ctx.fillText(shot.initial, shot.start.x, shot.start.y + 1);
                    ctx.fillStyle = shot.color; ctx.strokeStyle = 'white'; ctx.lineWidth = 1.5;
                    ctx.beginPath(); ctx.arc(shot.end.x, shot.end.y, 6, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                });
            }

            // „Ç¨„Ç§„Éâ
            if (tempStartPoint) {
                const sx = tempStartPoint.x; const sy = tempStartPoint.y;
                const activeColor = PLAYER_COLORS[activeHitterIndex];
                ctx.fillStyle = `rgba(255, 255, 255, 0.4)`;
                ctx.beginPath(); ctx.arc(sx, sy, 16, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = activeColor.bg;
                ctx.beginPath(); ctx.arc(sx, sy, 12, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = activeColor.text; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.font = 'bold 12px sans-serif';
                ctx.fillText(getCurrentInitial(), sx, sy + 1);
            }
        }

        function parseColor(c) {
            if (c === '#2196F3') return { r: 33, g: 150, b: 243 };
            if (c === '#F44336') return { r: 244, g: 67, b: 54 };
            return { r: 255, g: 255, b: 255 };
        }

        function getTouchPos(e) {
            const rect = canvas.getBoundingClientRect();
            let cx, cy;
            if (e.changedTouches && e.changedTouches.length > 0) {
                cx = e.changedTouches[0].clientX; cy = e.changedTouches[0].clientY;
            } else {
                cx = e.clientX; cy = e.clientY;
            }
            return { x: cx - rect.left, y: cy - rect.top };
        }

        function handleInput(e) {
            if(e.cancelable) e.preventDefault();
            const loc = getTouchPos(e);

            if (!tempStartPoint) {
                tempStartPoint = loc;
                statusLabel.textContent = "ÁùÄÂºæÁÇπ„Çí„Çø„ÉÉ„Éó";
            } else {
                const start = tempStartPoint; const end = loc;
                const { ox, oy, w, h, netY } = courtGeometry;
                const x = end.x; const y = end.y;

                let c = 'white'; let m = "IN";
                if (Math.abs(y - netY) < (h * 0.05)) { c = '#2196F3'; m = "NET"; }
                else if ((ox <= x && x <= ox + w) && (oy <= y && y <= oy + h)) { c = 'white'; m = "IN"; }
                else { c = '#F44336'; m = "OUT"; }

                const initial = getCurrentInitial();
                shots.push({ 
                    start, end, color: c, initial, 
                    hitterIndex: activeHitterIndex, type: currentShotType 
                });
                tempStartPoint = null;
                statusLabel.textContent = `${m} (${initial}) ÂÆå‰∫Ü`;
            }
            draw();
        }

        canvas.addEventListener('mousedown', handleInput);
        canvas.addEventListener('touchstart', handleInput, {passive: false});

        document.getElementById('sw-lines').addEventListener('change', (e) => { config.showLines = e.target.checked; draw(); });
        document.getElementById('sw-marks').addEventListener('change', (e) => { config.showMarks = e.target.checked; draw(); });

        document.getElementById('btn-undo').addEventListener('click', () => {
            if (tempStartPoint) { tempStartPoint = null; statusLabel.textContent = "„Ç≠„É£„É≥„Çª„É´"; }
            else if (shots.length > 0) { shots.pop(); statusLabel.textContent = "1„Å§Êàª„Åó„Åæ„Åó„Åü"; }
            draw();
        });

        document.getElementById('btn-clear').addEventListener('click', () => {
            if (confirm('Ê∂àÂéª„Åó„Åæ„Åô„ÅãÔºü')) {
                shots = []; tempStartPoint = null; statusLabel.textContent = "‚ë†ÊâìÁÇπ„Çí„Çø„ÉÉ„Éó"; draw();
            }
        });

        document.getElementById('btn-save').addEventListener('click', () => {
            try {
                const link = document.createElement('a');
                const t = inputTournament.value.trim();
                const d = inputDate.value;
                const p1 = inputP1.value.trim(), p2 = inputP2.value.trim();
                const o1 = inputO1.value.trim(), o2 = inputO2.value.trim();

                let name = "";
                if (t) name += `${t}_`;
                let mt = (p1&&p2) ? `${p1}„Éª${p2}` : (p1||p2);
                let ot = (o1&&o2) ? `${o1}„Éª${o2}` : (o1||o2);
                if (mt) name += mt;
                if (mt && ot) name += "_vs_";
                if (ot) name += ot;
                if (name) name += "_";
                
                if (d) name += d.replace(/[-:]/g, '').replace('T', '_');
                else name += "tennis_record";
                
                link.download = name + ".png";

                const margin = 30; 
                const cutX = (courtGeometry.ox - margin) * dpr;
                const cutY = (courtGeometry.oy - margin) * dpr;
                const cutW = (courtGeometry.w + margin * 2) * dpr;
                const cutH = (courtGeometry.h + margin * 2) * dpr;
                const finalX = Math.max(0, cutX);
                const finalY = Math.max(0, cutY);
                const finalW = Math.min(canvas.width - finalX, cutW);
                const finalH = Math.min(canvas.height - finalY, cutH);

                const offCanvas = document.createElement('canvas');
                offCanvas.width = finalW; offCanvas.height = finalH;
                const offCtx = offCanvas.getContext('2d');
                offCtx.setLineDash([]);
                offCtx.drawImage(canvas, finalX, finalY, finalW, finalH, 0, 0, finalW, finalH);
                
                link.href = offCanvas.toDataURL('image/png');
                link.click();
                statusLabel.textContent = "‰øùÂ≠ò„Åó„Åæ„Åó„Åü";
            } catch(e) { statusLabel.textContent = "‰øùÂ≠ò„Ç®„É©„Éº"; }
        });

        init();
    </script>
</body>
</html>
